# Web Command Palette - 想定動作一覧

## 概要

このドキュメントは、現在の実装から想定される動作を一覧にまとめたものです。要件との比較やテストケースの作成に活用できます。

## 基本動作

### 1. パレットの起動と終了

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| パレットを開く | ⌘P / Ctrl+P | パレットが画面中央に表示され、入力フィールドにフォーカス | [`hotkey.ts`](src/core/hotkey.ts:1), [`main.ts`](src/main.ts:1) |
| パレットを閉じる | Escキー | パレットが非表示になり、フォーカスが元の要素に戻る | [`keyboard.ts`](src/core/keyboard.ts:1), [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |
| パレットを閉じる | オーバーレイクリック | パレットが非表示になる | [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |
| 自動でパレットを開く | 設定されたURLにアクセス | パレットが自動的に表示される | [`hotkey.ts`](src/core/hotkey.ts:1) |

### 2. 検索とフィルタリング

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| サイト名で検索 | テキスト入力 | 入力文字に一致するサイトがリスト表示される | [`search.ts`](src/utils/search.ts:1), [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |
| URLで検索 | テキスト入力 | 入力文字に一致するURLのサイトがリスト表示される | [`search.ts`](src/utils/search.ts:1) |
| タグでフィルタ | `#タグ名` 入力 | 指定されたタグを持つサイトのみが表示される | [`search.ts`](src/utils/search.ts:1) |
| 階層タグでフィルタ | `#親/子` 入力 | 階層タグに一致するサイトが表示される | [`search.ts`](src/utils/search.ts:1) |
| タグとテキストで検索 | `#タグ名 キーワード` | タグで絞り込んだ上でキーワード検索 | [`search.ts`](src/utils/search.ts:1) |
| ファジー検索 | 曖昧な入力（例: `gthb`） | 入力に近いサイトが候補として表示される | [`search.ts`](src/utils/search.ts:1) |
| 検索結果の並び替え | 検索実行 | 使用頻度の高いサイトが上位に表示される | [`search.ts`](src/utils/search.ts:1) |

### 3. ナビゲーションと選択

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| 次のアイテムを選択 | ↓キー | アクティブなアイテムが一つ下に移動 | [`keyboard.ts`](src/core/keyboard.ts:1), [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |
| 前のアイテムを選択 | ↑キー | アクティブなアイテムが一つ上に移動 | [`keyboard.ts`](src/core/keyboard.ts:1), [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |
| アイテムをマウスで選択 | マウスホバー | ホバーしたアイテムがアクティブになる | [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |
| アイテムをクリックで選択 | クリック | クリックしたアイテムが実行される | [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |
| 先頭のアイテムを選択 | Homeキー | 最初のアイテムがアクティブになる | [`keyboard.ts`](src/core/keyboard.ts:1) |
| 最後のアイテムを選択 | Endキー | 最後のアイテムがアクティブになる | [`keyboard.ts`](src/core/keyboard.ts:1) |

### 4. サイトの実行

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| サイトを現在のタブで開く | Enterキー | 選択したサイトが現在のタブで開く | [`palette.ts`](src/core/palette.ts:1), [`keyboard.ts`](src/core/keyboard.ts:1) |
| サイトを新規タブで開く | Shift+Enter | 選択したサイトが新規タブで開く | [`palette.ts`](src/core/palette.ts:1), [`keyboard.ts`](src/core/keyboard.ts:1) |
| 検索サイトを実行 | Enterキー（検索テンプレート） | 検索クエリ入力モードになる | [`palette.ts`](src/core/palette.ts:1) |
| 検索クエリ入力 | テキスト入力（検索モード） | 入力したキーワードで検索が実行される | [`palette.ts`](src/core/palette.ts:1) |
| Bing検索を実行 | ⌘+Enter / Ctrl+Enter | 入力したキーワードでBing検索が実行される | [`keyboard.ts`](src/core/keyboard.ts:1), [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |

### 5. オートコンプリート機能

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| タグ候補を表示 | `#` を入力 | 利用可能なタグのリストが表示される | [`autocomplete.ts`](src/components/autocomplete.ts:1) |
| タグ候補をナビゲート | ↑↓キー | 候補リスト内で選択が移動する | [`autocomplete.ts`](src/components/autocomplete.ts:1) |
| タグ候補を選択 | Enterキー | 選択したタグが入力され、スペースが追加される | [`autocomplete.ts`](src/components/autocomplete.ts:1) |
| 新規タグを作成 | 存在しないタグ名を入力してEnter | 新しいタグが作成されて入力される | [`autocomplete.ts`](src/components/autocomplete.ts:1) |
| オートコンプリートを閉じる | Escキー | 候補リストが閉じる | [`autocomplete.ts`](src/components/autocomplete.ts:1) |

### 6. サイト管理

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| サイトマネージャを開く | 「サイトマネージャを開く」リンククリック | サイト管理画面が表示される | [`manager.ts`](src/components/manager.ts:1), [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |
| 現在のページを追加 | 「現在のページを追加」コマンド実行 | 現在のページ情報がサイトとして追加される | [`main.ts`](src/main.ts:1), [`palette.ts`](src/core/palette.ts:1) |
| URLをコピー | 「URLをコピー」コマンド実行 | 現在のページURLがクリップボードにコピーされる | [`palette.ts`](src/core/palette.ts:1) |
| サイトを編集 | サイトマネージャで編集ボタンクリック | サイト情報編集モードになる | [`manager.ts`](src/components/manager.ts:1) |
| サイトを削除 | サイトマネージャで削除ボタンクリック | サイトが削除される | [`manager.ts`](src/components/manager.ts:1) |
| サイトをインポート | JSONファイルをインポート | サイトデータが追加される | [`manager.ts`](src/components/manager.ts:1) |
| サイトをエクスポート | エクスポートボタンクリック | サイトデータがJSONとしてダウンロードされる | [`manager.ts`](src/components/manager.ts:1) |

### 7. 設定管理

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| 設定画面を開く | 「設定」リンククリック | 設定画面が表示される | [`settings.ts`](src/components/settings.ts:1), [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |
| ホットキーを変更 | 設定画面でホットキー入力 | 新しいホットキーが設定される | [`settings.ts`](src/components/settings.ts:1) |
| テーマを切り替え | テーマ選択 | ダーク/ライトテーマが切り替わる | [`settings.ts`](src/components/settings.ts:1), [`palette-ui.ts`](src/components/palette-ui.ts:1) |
| アクセントカラーを変更 | カラーピッカー使用 | 選択した色がアクセントカラーになる | [`settings.ts`](src/components/settings.ts:1) |
| ブロックサイトを設定 | ブロックリスト入力 | 指定されたサイトでパレットが無効になる | [`settings.ts`](src/components/settings.ts:1), [`hotkey.ts`](src/core/hotkey.ts:1) |
| faviconキャッシュをクリア | クリアボタンクリック | faviconキャッシュが削除される | [`settings.ts`](src/components/settings.ts:1) |

### 8. パフォーマンス関連

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| 仮想スクロールが有効になる | アイテム数が50以上 | 表示領域外のアイテムはレンダリングされない | [`virtual-scroll.ts`](src/utils/virtual-scroll.ts:1), [`palette-ui.ts`](src/components/palette-ui.ts:1) |
| 検索結果がデバウンスされる | 高速なテキスト入力 | 150msごとに検索が実行される | [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1), [`debounce.ts`](src/utils/debounce.ts:1) |
| faviconがキャッシュされる | サイト初回表示 | faviconがキャッシュされ、次回から高速表示 | [`dom.ts`](src/utils/dom.ts:1), [`storage.ts`](src/core/storage.ts:1) |

### 9. エラーハンドリング

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| 検索結果が空 | 存在しないキーワード入力 | 「一致なし」と表示される | [`palette-ui.ts`](src/components/palette-ui.ts:1) |
| サイトが未登録 | 空の状態で検索 | サイト登録を促すメッセージが表示される | [`palette-ui.ts`](src/components/palette-ui.ts:1) |
| 検索キーワードが空 | 検索テンプレートでEnter | 「検索キーワードを入力してください」と表示 | [`palette.ts`](src/core/palette.ts:1) |
| URLコピー失敗 | クリップボードアクセス拒否 | エラーメッセージが表示される | [`palette.ts`](src/core/palette.ts:1) |

### 10. アクセシビリティ

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| フォーカストラップ | パレット表示 | フォーカスがパレット内に制限される | [`events.ts`](src/utils/events.ts:1), [`palette-ui.ts`](src/components/palette-ui.ts:1) |
| タブナビゲーション | Tabキー | フォーカスが順に移動する | [`keyboard.ts`](src/core/keyboard.ts:1) |
| Shift+Tabナビゲーション | Shift+Tab | フォーカスが逆順に移動する | [`events.ts`](src/utils/events.ts:1) |
| スクリーンリーダー対応 | パレット表示 | 適切なARIAラベルが提供される | [`palette-ui.ts`](src/components/palette-ui.ts:1) |

## 特殊な動作

### 1. 日本語入力対応

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| 日本語入力中の処理 | IME入力中 | 変換確定まで検索が実行されない | [`keyboard.ts`](src/core/keyboard.ts:1), [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |
| 変換確定後の検索 | 変換確定 | 確定したテキストで検索が実行される | [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) |

### 2. ブラウザ互換性

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| GM_APIのフォールバック | API不可 | ネイティブAPIにフォールバックする | [`palette.ts`](src/core/palette.ts:1), [`dom.ts`](src/utils/dom.ts:1) |
| CSSカスタムプロパティ | 非対応ブラウザ | デフォルトスタイルが適用される | [`palette-ui.ts`](src/components/palette-ui.ts:1) |

### 3. データ永続化

| 動作 | トリガー | 期待される結果 | 関連ファイル |
|------|----------|----------------|------------|
| サイトデータの保存 | サイト追加/編集/削除 | GM_setValueでデータが保存される | [`storage.ts`](src/core/storage.ts:1) |
| 設定の保存 | 設定変更 | GM_setValueで設定が保存される | [`storage.ts`](src/core/storage.ts:1) |
| 使用回数の記録 | サイト実行 | 使用回数が増加して保存される | [`storage.ts`](src/core/storage.ts:1) |

## 状態遷移

### 1. パレットのライフサイクル

```
非表示 → 起動中 → 表示中 → 検索中 → 実行中 → 非表示
   ↑__________ Escキー/実行完了 __________↓
```

### 2. 検索状態の遷移

```
初期状態 → テキスト入力 → 検索実行 → 結果表示 → 選択 → 実行
    ↓           ↓           ↓          ↓        ↓
タグ入力 → タグ候補表示 → タグ選択 → タグ確定 → 検索実行
```

### 3. オートコンプリート状態

```
非表示 → 入力待ち → 候補表示 → 選択中 → 確定 → 非表示
   ↑_______ Escキー/選択確定 _______↓
```

## パフォーマンス要件

| 項目 | 期待される値 | 測定方法 | 関連ファイル |
|------|-------------|----------|------------|
| パレット表示時間 | < 100ms | 起動から表示までの時間 | [`palette-ui.ts`](src/components/palette-ui.ts:1) |
| 検索応答時間 | < 150ms | 入力から結果表示まで | [`search.ts`](src/utils/search.ts:1), [`debounce.ts`](src/utils/debounce.ts:1) |
| 大量アイテム表示 | 1000アイテムで60fps | スクロール中のフレームレート | [`virtual-scroll.ts`](src/utils/virtual-scroll.ts:1) |
| メモリ使用量 | < 10MB | 長時間使用後のメモリ使用量 | 全体 |

## 互換性要件

| 項目 | 対応範囲 | 備考 | 関連ファイル |
|------|----------|------|------------|
| ブラウザ | Chrome, Firefox, Edge, Safari | モダンブラウザ | 全体 |
| ユーザースクリプト | Tampermonkey, Violentmonkey | Greasemonkeyは部分的対応 | [`main.ts`](src/main.ts:1) |
| 画面サイズ | 最小幅320px | モバイル対応 | [`palette-ui.ts`](src/components/palette-ui.ts:1) |

この想定動作一覧は、現在の実装から抽出した動作を網羅的にまとめたものです。要件定義やテスト計画の際に活用できます。