# Web Command Palette - ファイル構造解説

これはブラウザ上で動作するユーザースクリプト製コマンドパレットのプロジェクト構造解説です。

## プロジェクト概要

このプロジェクトは、TypeScriptで開発されたユーザースクリプトで、⌘P / Ctrl+P キーで起動するコマンドパレットを実装しています。サイトの素早い起動、タグフィルタリング、使用頻度学習などの機能を提供します。

## 全体構成

```
web-command-palette/
├── src/                    # ソースコードディレクトリ
│   ├── main.ts            # アプリケーションのエントリーポイント
│   ├── components/        # UIコンポーネント
│   ├── core/              # コアロジック
│   ├── types/             # TypeScript型定義
│   ├── constants/         # 定数定義
│   └── utils/             # ユーティリティ関数
├── tests/                 # テストファイル
├── dist/                  # ビルド出力先
└── 設定ファイル群
```

## ディレクトリ詳細

### src/ - ソースコードディレクトリ

#### main.ts
アプリケーションのメインエントリーポイント。[`CommandPaletteApp`](src/main.ts:20) クラスを定義し、アプリケーション全体の初期化とコンポーネントの連携を管理します。

#### components/ - UIコンポーネント
UIの各要素を担当するコンポーネント群：

- [`palette.ts`](src/components/palette.ts:1) - メインパレットUIを管理
- [`palette-ui.ts`](src/components/palette-ui.ts:1) - パレットのUI生成を担当
- [`palette-event-handler.ts`](src/components/palette-event-handler.ts:1) - パレットのイベント処理を担当
- [`autocomplete.ts`](src/components/autocomplete.ts:1) - オートコンプリート機能
- [`manager.ts`](src/components/manager.ts:1) - サイトマネージャUI
- [`settings.ts`](src/components/settings.ts:1) - 設定UI
- [`search-suggestions.ts`](src/components/search-suggestions.ts:1) - 検索候補表示

#### core/ - コアロジック
アプリケーションの中心的な機能を実装：

- [`palette.ts`](src/core/palette.ts:1) - パレットのコアロジック（[`PaletteCore`](src/core/palette.ts:12)クラス）
- [`state.ts`](src/core/state.ts:1) - アプリケーション状態管理
- [`storage.ts`](src/core/storage.ts:1) - データストレージ管理
- [`hotkey.ts`](src/core/hotkey.ts:1) - グローバルホットキー処理
- [`keyboard.ts`](src/core/keyboard.ts:1) - キーボードイベント処理
- [`history.ts`](src/core/history.ts:1) - 履歴管理
- [`shortcuts.ts`](src/core/shortcuts.ts:1) - ショートカット処理

#### types/ - TypeScript型定義
アプリケーション全体で使用される型定義：

- [`site.ts`](src/types/site.ts:1) - サイトエントリの型定義
- [`settings.ts`](src/types/settings.ts:1) - 設定の型定義
- [`storage.ts`](src/types/storage.ts:1) - ストレージ関連の型定義
- [`globals.ts`](src/types/globals.ts:1) - グローバル変数の型定義

#### constants/ - 定数定義
アプリケーション全体で使用される定数：

- [`defaults.ts`](src/constants/defaults.ts:1) - デフォルト値
- [`themes.ts`](src/constants/themes.ts:1) - テーマ定義
- [`keys.ts`](src/constants/keys.ts:1) - キーコード定義
- [`timing.ts`](src/constants/timing.ts:1) - タイミング関連定数

#### utils/ - ユーティリティ関数
様々なユーティリティ関数群：

- [`search.ts`](src/utils/search.ts:1) - 検索ロジック（タグフィルタ、ファジー検索など）
- [`string.ts`](src/utils/string.ts:1) - 文字列処理関数
- [`dom.ts`](src/utils/dom.ts:1) - DOM操作関数
- [`dom-helpers.ts`](src/utils/dom-helpers.ts:1) - DOMヘルパー関数
- [`ui.ts`](src/utils/ui.ts:1) - UI関連ユーティリティ
- [`debounce.ts`](src/utils/debounce.ts:1) - デバウンス処理
- [`animations.ts`](src/utils/animations.ts:1) - アニメーション処理
- [`virtual-scroll.ts`](src/utils/virtual-scroll.ts:1) - 仮想スクロール実装
- [`error-handler.ts`](src/utils/error-handler.ts:1) - エラーハンドリング
- [`events.ts`](src/utils/events.ts:1) - イベント処理ユーティリティ

### tests/ - テストファイル
Jestを使用したテストファイル群：

- [`setup.ts`](tests/setup.ts:1) - テスト環境設定
- 各コンポーネントやユーティリティのテストファイル

### 設定ファイル

#### package.json
プロジェクトのメタ情報と依存関係を定義。TypeScript、Rollup、Jestなどの開発ツールを使用。

#### tsconfig.json
TypeScriptコンパイラ設定。ES2020をターゲットとし、パスエイリアス（`@/*`）を設定。

#### rollup.config.js
Rollupバンドラー設定。TypeScriptをJavaScriptに変換し、ユーザースクリプト形式で出力。

#### jest.config.js
Jestテストフレームワークの設定。

## アーキテクチャの特徴

### 1. モジュール設計
- 機能ごとに明確に分離されたモジュール構造
- 依存関係を最小限に抑えた設計

### 2. コンポーネント分離
- UI生成とイベント処理を分離したアーキテクチャ
- [`Palette`](src/components/palette.ts:13)クラスがUIとイベントハンドラを調整

### 3. 状態管理
- [`AppState`](src/core/state.ts:1)と[`DOMElements`](src/core/state.ts:1)で一元管理
- ストレージとの連携でデータ永続化

### 4. 検索システム
- [`search.ts`](src/utils/search.ts:1)に高度な検索ロジックを実装
- タグフィルタ、ファジー検索、使用頻度学習

### 5. ユーザースクリプト対応
- GM_* APIを使用してブラウザ機能と連携
- [`rollup.config.js`](rollup.config.js:9)でユーザースクリプトヘッダーを設定

## ビルドプロセス

1. **開発**: `npm run dev` - Rollupのウォッチモードで開発
2. **ビルド**: `npm run build` - 本番用にビルド
3. **テスト**: `npm test` - Jestでテスト実行
4. **型チェック**: `npm run type-check` - TypeScriptの型チェック

ビルド結果は[`dist/script.user.js`](dist/script.user.js)として出力され、ユーザースクリプトマネージャ（Tampermonkey/Violentmonkey）で読み込まれます。

## 拡張性

このプロジェクトは以下の点で拡張性が高い設計になっています：

- プラグイン的なコンポーネント追加
- 検索アルゴリズムの拡張
- テーマシステムのカスタマイズ
- 新しいコマンドタイプの追加

ファイル構造は機能ごとに整理されており、新機能の追加や既存機能の修正が容易に行えるよう設計されています。